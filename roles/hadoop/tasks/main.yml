---

- name: install Hadoop
  when: install_hadoop | default(true) # So we can depend on this role just for the vars, if nessesary
  block:

    - name: Create common dirs
      ansible.builtin.file:
        path: "{{ item }}"
        owner: "root"
        group: "{{ hadoop_group.name }}"
        state: directory
        mode: 0775
      with_items:
        - "{{ hadoop_log_dir }}"
        - "{{ hadoop_tmp }}"



    - name: ensure hadoop directory exists
      ansible.builtin.file:
        path: "{{ hadoop_path }}"
        state: directory


    - ansible.builtin.debug:
        msg: "Downloading hadoop from {{ hadoop_download }}"


    - name: Unzip Hadoop
      ansible.builtin.unarchive:
        src: "{{ hadoop_download }}"
        dest: "{{ hadoop_path }}"
        remote_src: yes
        creates: "{{ hadoop_home }}"
        group: "{{ hadoop_group.name }}"
        owner: "root"

    - name: "Link {{ hadoop_home }} to {{ current_hadoop_home }}"
      ansible.builtin.file:
        src: "{{ hadoop_home }}"
        dest: "{{ current_hadoop_home }}"
        state: link

- name: Configure Hadoop
  when: install_hadoop | default(true) and configure_hadoop | default(true)
  block:
    - name: Upload Hadoop config files
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "{{ hadoop_config_path }}/"
        mode: 0644
        owner: "root"
        group: "{{ hadoop_group.name }}"
      with_fileglob:
        - "templates/hadoop_conf/*"

    - name: remove {{ hadoop_home }}/etc/hadoop
      ansible.builtin.file:
        path: "{{ hadoop_home }}/etc/hadoop"
        state: absent
    - name: symlink {{ hadoop_home }}/etc/hadoop to {{ hadoop_config_path }}
      ansible.builtin.file:
        src: "{{ hadoop_config_path }}"
        dest:  "{{ hadoop_home }}/etc/hadoop"
        owner: root
        group: "{{ hadoop_group.name }}"
        state: link
        force: true

    - name: Set the right permissions for container-executor
      ansible.builtin.file:
        path: "{{ hadoop_home }}/bin/container-executor"
        owner: root
        group: "{{ hadoop_group.name }}"
        mode: '6050'

    - name: install log4jSyslogWriter64k in classpath
      include_tasks: installLog4jSyslogAppender.yml
      vars:
        dest: "{{ hadoop_home }}/share/hadoop/common/lib/"
        owner:
          name: root
          group: "{{ hadoop_group.name }}"

    - name: Upload Hadoop daemon invoker Script
      ansible.builtin.template:
        src: "hadoop-invoker.sh"
        dest: "/usr/local/bin/"
        mode: "0755"
        owner: "root"
        group: "{{ hadoop_group.name }}"

    - name: Upload Hadoop profile files
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/etc/profile.d/"
        mode: 0644
        owner: "root"
        group: "{{ hadoop_group.name }}"
      with_fileglob:
        - "templates/profile.d/*"

    - name: Upload Hadoop YARN systemd services
      when: install_yarn | default(true)
      ansible.builtin.template:
        src: "{{ item }}"
        dest: /etc/systemd/system/
        mode: 0644
        owner: "root"
        group: "root"
      with_fileglob:
        - "templates/systemd/yarn/*"

    - name: Upload Hadoop HDFS systemd services
      when: install_hdfs | default(true)
      ansible.builtin.template:
        src: "{{ item }}"
        dest: /etc/systemd/system/
        mode: 0644
        owner: "root"
        group: "root"
      with_fileglob:
        - "templates/systemd/hdfs/*"

    - name: Upload Hadoop Mapreduce systemd services
      when: install_mapreduce | default(true)
      ansible.builtin.template:
        src: "{{ item }}"
        dest: /etc/systemd/system/
        mode: 0644
        owner: "root"
        group: "root"
      with_fileglob:
        - "templates/systemd/mapreduce/*"


