---

- name: Create system user keytabs dir
  file:
    owner: root
    group: "{{ hadoop_group.name }}"
    mode: 0750
    path: "{{ dir }}"
    state: "directory"
  loop: '{{ kerberos_conf | selectattr("type", "eq", "USER") | map(attribute="keytab_file") | map("dirname") |unique| list }}'
  loop_control:
    loop_var: "dir"



- name: "uploading headless keytabs to hosts"
  throttle: 2
  connection: ssh
#  delegate_to: "{{ groups['hostgroup_ssl_creator'] | first }}"
  synchronize:
    src: "{{ item }}"
    dest: "{{ keytab_dir }}"
    mode: push
    # Be root on the dest side, so we can create the files in /etc
    rsync_path: sudo rsync
  loop: '{{ kerberos_conf | selectattr("type", "eq", "USER") | map(attribute="keytab_file") |unique| list }}'

